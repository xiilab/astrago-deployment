#repositories:
#- name: csi-driver-nfs
#  url: https://raw.githubusercontent.com/kubernetes-csi/csi-driver-nfs/master/charts
#- name: volcano-sh 
#  url: https://volcano-sh.github.io/helm-charts
#- name: fluxcd-community
#  url: https://fluxcd-community.github.io/helm-charts
#- name: nvidia
#  url: https://nvidia.github.io/gpu-operator
#- name: grafana
#  url: https://grafana.github.io/helm-charts
#- name: prometheus-community
#  url: https://prometheus-community.github.io/helm-charts
#- name: keycloak
#  url: oci://registry-1.docker.io/bitnamicharts/keycloak
#- name: kubeflow
#  url: https://kubeflow.github.io/helm-charts
#- name: harbor
#  url: https://helm.goharbor.io

environments:
  prod:
    values:
    - environments/common/values.yaml
    - environments/prod/values.yaml
  dev:
    values:
    - environments/common/values.yaml
    - environments/dev/values.yaml
  dev2:
    values:
    - environments/common/values.yaml
    - environments/dev2/values.yaml
  stage:
    values:
    - environments/common/values.yaml
    - environments/stage/values.yaml
  seoultech:
    values:
    - environments/common/values.yaml
    - environments/seoultech/values.yaml
  astrago:
    values:
    - environments/common/values.yaml
    - environments/astrago/values.yaml

helmDefaults:
  wait: true
  waitForJobs: true
  timeout: 600
  createNamespace: true

releases:
# 1단계: 기반 인프라 (의존성 없음)
- name: nfs-provisioner
  namespace: nfs-provisioner
  chart: charts/csi-driver-nfs
  version: v4.7.0
  labels:
    app: nfs-provisioner
  values:
  - values/csi-driver-nfs/values.yaml.gotmpl

- name: keycloak-extras
  namespace: keycloak
  chart: charts/keycloak-extras
  version: 1.0.0
  labels:
    app: keycloak

- name: gpu-operator
  namespace: gpu-operator
  chart: charts/gpu-operator
  version: v24.9.2
  labels:
    app: gpu-operator
    type: infra
  values:
  - values/gpu-operator/values.yaml.gotmpl

- name: volcano
  namespace: volcano-system
  chart: charts/volcano
  version: 1.12.1
  labels:
    app: volcano
  values:
  - values/volcano/values.yaml

- name: flux
  namespace: flux
  chart: charts/flux2
  version: 2.13.0
  labels:
    app: flux
  values:
  - values/flux/values.yaml.gotmpl

- name: mpi-operator
  chart: charts/mpi-operator
  version: 0.1.0
  labels:
    app: mpi-operator
  values:
  - values/mpi-operator/values.yaml.gotmpl

# 2단계: 확장 구성요소 (명확한 의존성은 needs 유지)
- name: gpu-operator-extras
  namespace: gpu-operator
  chart: charts/gpu-operator-extras
  version: 1.0.0
  labels:
    app: gpu-operator
    type: infra
  needs:
  - gpu-operator/gpu-operator

- name: gpu-process-exporter
  chart: charts/gpu-process-exporter
  namespace: gpu-operator
  version: 1.0.0
  labels:
    app: gpu-process-exporter
  values:
  - values/gpu-process-exporter/values.yaml.gotmpl
  needs:
  - gpu-operator/gpu-operator

- name: volcano-vgpu-device-plugin
  namespace: volcano-system
  chart: charts/volcano-vgpu-device-plugin
  version: 1.0.0
  labels:
    app: volcano
  needs:
  - volcano-system/volcano

# 3단계: 미들웨어 서비스 (순서로 nfs 의존성 해결)
- name: keycloak
  namespace: keycloak
  chart: charts/keycloak
  version: 17.3.5
  labels:
    app: keycloak
  values:
  - values/keycloak/values.yaml.gotmpl
  needs:
  - keycloak/keycloak-extras

- name: loki-stack
  namespace: loki-stack
  chart: charts/loki-stack
  version: 1.0.0
  labels:
    app: loki-stack
    component: logging
  values:
  - values/loki-stack/values.yaml.gotmpl

- name: prometheus
  namespace: prometheus
  chart: charts/kube-prometheus-stack
  version: 55.4.0
  labels:
    app: prometheus
  values:
  - values/kube-prometheus-stack/values.yaml.gotmpl

- name: harbor
  namespace: harbor
  chart: charts/harbor
  version: 1.15.1
  condition: harbor.enabled
  labels:
    app: harbor
  values:
  - values/harbor/values.yaml.gotmpl

# 4단계: 메인 애플리케이션 (순서로 keycloak 의존성 해결)
- name: astrago
  namespace: astrago
  chart: charts/astrago
  version: 0.1.0
  labels:
    app: astrago
  values:
  - values/astrago/values.yaml.gotmpl
