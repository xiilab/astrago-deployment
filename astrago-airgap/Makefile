# Astrago Airgap Makefile - ê°„ì†Œí™”ëœ ì¸í„°í˜ì´ìŠ¤
# kubespray-offline + Astrago ì˜¤ë²„ë ˆì´ ë°©ì‹

.PHONY: help prepare download package deploy clean update-kubespray status

OVERLAY_SCRIPTS = ./astrago-overlay/scripts

help: ## ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡ í‘œì‹œ
	@echo "Astrago Airgap ë°°í¬ ë„êµ¬ (kubespray-offline ê¸°ë°˜)"
	@echo "================================================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' Makefile | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

prepare: ## 1ë‹¨ê³„: í™˜ê²½ ì¤€ë¹„ ë° ê²€ì¦
	@$(OVERLAY_SCRIPTS)/1-prepare.sh

download: ## 2ë‹¨ê³„: ëª¨ë“  ì´ë¯¸ì§€ ë° íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ
	@$(OVERLAY_SCRIPTS)/2-download.sh

package: ## 3ë‹¨ê³„: ì˜¤í”„ë¼ì¸ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
	@$(OVERLAY_SCRIPTS)/3-package.sh

deploy: ## 4ë‹¨ê³„: ì˜¤í”„ë¼ì¸ í™˜ê²½ì—ì„œ ë°°í¬ (íƒ€ê²Ÿ í™˜ê²½)
	@$(OVERLAY_SCRIPTS)/4-deploy.sh

# í†µí•© ëª…ë ¹
build: prepare download package ## ì „ì²´ ë¹Œë“œ (1-3ë‹¨ê³„ í†µí•©)
	@echo "ğŸ‰ ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ë¹Œë“œ ì™„ë£Œ!"

# ìœ ì§€ë³´ìˆ˜ ëª…ë ¹
update-kubespray: ## kubespray-offline ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸
	@./update-kubespray.sh

update-kubespray-tag: ## íŠ¹ì • íƒœê·¸ë¡œ kubespray-offline ì—…ë°ì´íŠ¸ (ì˜ˆ: make update-kubespray-tag TAG=v1.2.3)
	@./update-kubespray.sh $(TAG)

clean: ## ì„ì‹œ íŒŒì¼ ë° ë¹Œë“œ ìºì‹œ ì •ë¦¬
	@echo "ğŸ§¹ ì •ë¦¬ ì¤‘..."
	@rm -rf ./outputs/temp
	@rm -rf ./temp
	@rm -rf ./astrago-overlay/images/imagelists/*.txt
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ"

status: ## í˜„ì¬ í™˜ê²½ ìƒíƒœ í™•ì¸
	@echo "ğŸ“Š Astrago Airgap ìƒíƒœ í™•ì¸:"
	@echo "===================================="
	@echo "kubespray-offline: $(shell cd kubespray-offline 2>/dev/null && git describe --tags --always 2>/dev/null || echo 'âŒ ì—†ìŒ')"
	@echo "Astrago ì˜¤ë²„ë ˆì´: $(shell test -d astrago-overlay && echo 'âœ… ì¤€ë¹„ë¨' || echo 'âŒ ì—†ìŒ')"
	@echo "Helmfile ê²½ë¡œ: $(shell test -d ../helmfile && echo 'âœ… ì¡´ì¬' || echo 'âŒ ì—†ìŒ')"
	@echo "ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸: $(shell test -x astrago-overlay/scripts/1-prepare.sh && echo 'âœ… ì¤€ë¹„ë¨' || echo 'âŒ ì—†ìŒ')"

# ê°œë°œ ë° í…ŒìŠ¤íŠ¸ ëª…ë ¹
test: ## í˜¸í™˜ì„± ë° ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
	@echo "ğŸ§ª í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	@echo "kubespray-offline ìƒíƒœ í™•ì¸..."
	@test -d kubespray-offline || (echo "âŒ kubespray-offline ì—†ìŒ" && exit 1)
	@test -f kubespray-offline/download-all.sh || (echo "âŒ download-all.sh ì—†ìŒ" && exit 1)
	@echo "Astrago ì˜¤ë²„ë ˆì´ ìƒíƒœ í™•ì¸..."
	@test -d astrago-overlay/scripts || (echo "âŒ ì˜¤ë²„ë ˆì´ ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ" && exit 1)
	@test -f astrago-overlay/configs/astrago.conf || (echo "âŒ ì„¤ì • íŒŒì¼ ì—†ìŒ" && exit 1)
	@echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"

init-submodule: ## Git submodule ì´ˆê¸°í™” (ì²˜ìŒ ì„¤ì • ì‹œ)
	@echo "ğŸ”§ Git submodule ì´ˆê¸°í™”..."
	@echo "âš ï¸  í˜„ì¬ kubespray-offlineì„ ë°±ì—…í•˜ê³  submoduleë¡œ ì „í™˜í•©ë‹ˆë‹¤."
	@read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@mv kubespray-offline kubespray-offline.backup
	@git submodule add https://github.com/kubespray-offline/kubespray-offline.git kubespray-offline
	@git submodule update --init --recursive
	@echo "âœ… Submodule ì´ˆê¸°í™” ì™„ë£Œ!"