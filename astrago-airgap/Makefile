# Astrago Airgap Makefile
# í‘œì¤€ ëª…ë ¹ì–´ ì¸í„°íŽ˜ì´ìŠ¤

.PHONY: help download package deploy clean test

# Load configuration
include airgap.conf

help: ## ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡ í‘œì‹œ
	@echo "Astrago Airgap ë°°í¬ ë„êµ¬"
	@echo "========================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' Makefile | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

download: ## ëª¨ë“  ì´ë¯¸ì§€ ë° íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ
	@echo "ðŸ”½ Downloading all images and packages..."
	@$(KUBESPRAY_PATH)/download-all.sh
	@$(ASTRAGO_SCRIPTS_PATH)/extract_astrago_images.sh
	@echo "âœ… Download completed"

package: ## ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
	@echo "ðŸ“¦ Creating deployment package..."
	@mkdir -p $(PACKAGE_OUTPUT_DIR)
	@$(ASTRAGO_SCRIPTS_PATH)/create_astrago_only_package.sh
	@echo "âœ… Package created in $(PACKAGE_OUTPUT_DIR)"

package-full: ## ì „ì²´ ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± (Kubernetes í¬í•¨)
	@echo "ðŸ“¦ Creating full deployment package..."
	@mkdir -p $(PACKAGE_OUTPUT_DIR)
	@$(ASTRAGO_SCRIPTS_PATH)/create_delivery_package.sh
	@echo "âœ… Full package created in $(PACKAGE_OUTPUT_DIR)"

deploy: ## Astrago ì˜¤í”„ë¼ì¸ ë°°í¬
	@echo "ðŸš€ Deploying Astrago..."
	@$(ASTRAGO_SCRIPTS_PATH)/offline_deploy_astrago.sh
	@echo "âœ… Deployment completed"

clean: ## ìž„ì‹œ íŒŒì¼ ë° ìºì‹œ ì •ë¦¬
	@echo "ðŸ§¹ Cleaning up..."
	@rm -rf $(PACKAGE_OUTPUT_DIR)/temp
	@rm -rf ./tmp
	@echo "âœ… Cleanup completed"

sync-images: ## helmfileì—ì„œ ëª¨ë“  ì´ë¯¸ì§€ ë™ê¸°í™”
	@echo "ðŸ”„ Syncing all images from helmfile..."
	@$(ASTRAGO_SCRIPTS_PATH)/sync_all_images.sh
	@echo "âœ… Image synchronization completed"

test: ## ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
	@echo "ðŸ§ª Running tests..."
	@./bin/test-compatibility.sh
	@echo "âœ… Tests completed"

status: ## í˜„ìž¬ ìƒíƒœ í™•ì¸
	@echo "ðŸ“Š Astrago Airgap Status:"
	@echo "========================="
	@echo "Kubespray-offline: $(shell cd $(KUBESPRAY_PATH) && git describe --tags --always)"
	@echo "Configuration: $(shell test -f airgap.conf && echo "âœ… OK" || echo "âŒ Missing")"
	@echo "Astrago scripts: $(shell test -d $(ASTRAGO_SCRIPTS_PATH) && echo "âœ… OK" || echo "âŒ Missing")"
	@echo "Image lists: $(shell ls $(ASTRAGO_IMAGELISTS_PATH)/*.txt 2>/dev/null | wc -l | xargs) files"

# ê°œë°œìš© ëª…ë ¹ì–´
dev-setup: ## ê°œë°œ í™˜ê²½ ì„¤ì •
	@echo "ðŸ”§ Setting up development environment..."
	@git submodule update --init --recursive
	@echo "âœ… Development environment ready"

dev-reset: ## ê°œë°œ í™˜ê²½ ë¦¬ì…‹
	@echo "ðŸ”„ Resetting development environment..."
	@git submodule update --init --recursive
	@git clean -fd
	@echo "âœ… Environment reset"