.PHONY: all build build-all clean install test lint fmt deps help

# ë³€ìˆ˜ ì •ì˜
BINARY_NAME := extract-images
VERSION := $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
BUILD_TIME := $(shell date -u '+%Y-%m-%d_%H:%M:%S')
COMMIT := $(shell git rev-parse --short HEAD 2>/dev/null || echo "none")
LDFLAGS := -ldflags "-X main.version=$(VERSION) -X main.commit=$(COMMIT) -X main.date=$(BUILD_TIME)"

# Go í™˜ê²½ ë³€ìˆ˜
GO := go
GOFLAGS := -v
GOTEST := $(GO) test -v -race -coverprofile=coverage.out

# ê¸°ë³¸ íƒ€ê²Ÿ
all: test build

# í˜„ì¬ í”Œë«í¼ìš© ë¹Œë“œ
build:
	@echo "ğŸ”¨ Building for $(shell go env GOOS)/$(shell go env GOARCH)..."
	$(GO) build $(GOFLAGS) $(LDFLAGS) -o bin/$(BINARY_NAME)-$(shell go env GOOS)-$(shell go env GOARCH) ./cmd/extractor
	@echo "âœ… Build complete: bin/$(BINARY_NAME)-$(shell go env GOOS)-$(shell go env GOARCH)"

# í¬ë¡œìŠ¤ ì»´íŒŒì¼ (ëª¨ë“  í”Œë«í¼)
build-all:
	@echo "ğŸ”¨ Building for multiple platforms..."
	@mkdir -p bin
	GOOS=linux GOARCH=amd64 $(GO) build $(LDFLAGS) -o bin/$(BINARY_NAME)-linux-amd64 ./cmd/extractor
	GOOS=linux GOARCH=arm64 $(GO) build $(LDFLAGS) -o bin/$(BINARY_NAME)-linux-arm64 ./cmd/extractor
	GOOS=darwin GOARCH=amd64 $(GO) build $(LDFLAGS) -o bin/$(BINARY_NAME)-darwin-amd64 ./cmd/extractor
	GOOS=darwin GOARCH=arm64 $(GO) build $(LDFLAGS) -o bin/$(BINARY_NAME)-darwin-arm64 ./cmd/extractor
	@echo "âœ… All platforms built successfully:"
	@ls -lh bin/

# í…ŒìŠ¤íŠ¸
test:
	@echo "ğŸ§ª Running tests..."
	$(GOTEST) ./...

# í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ (HTML ë¦¬í¬íŠ¸)
test-coverage:
	@echo "ğŸ“Š Generating coverage report..."
	$(GO) test -v -race -coverprofile=coverage.out -covermode=atomic ./...
	$(GO) tool cover -html=coverage.out -o coverage.html
	@echo "âœ… Coverage report generated: coverage.html"
	@$(GO) tool cover -func=coverage.out | grep total | awk '{print "Total coverage: " $$3}'

# í†µí•© í…ŒìŠ¤íŠ¸
test-integration:
	@echo "ğŸ§ª Running integration tests..."
	$(GOTEST) ./test/integration/... -tags=integration

# ë²¤ì¹˜ë§ˆí¬
bench:
	@echo "ğŸ“Š Running benchmarks..."
	$(GO) test -bench=. -benchmem ./...

# ì •ì  ë¶„ì„ (golangci-lint í•„ìš”)
lint:
	@echo "ğŸ” Running linter..."
	@which golangci-lint > /dev/null || (echo "golangci-lint not installed. Run: brew install golangci-lint" && exit 1)
	golangci-lint run

# í¬ë§·íŒ…
fmt:
	@echo "âœ¨ Formatting code..."
	$(GO) fmt ./...
	@which goimports > /dev/null && goimports -w . || echo "goimports not installed, skipping"

# ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
deps:
	@echo "ğŸ“¦ Updating dependencies..."
	$(GO) mod download
	$(GO) mod tidy
	$(GO) mod verify
	@echo "âœ… Dependencies updated"

# ì„¤ì¹˜ (ë¡œì»¬ ì‹œìŠ¤í…œì—)
install: build
	@echo "ğŸ“¦ Installing $(BINARY_NAME)..."
	@mkdir -p ../../tools/$(shell go env GOOS)
	cp bin/$(BINARY_NAME)-$(shell go env GOOS)-$(shell go env GOARCH) ../../tools/$(shell go env GOOS)/$(BINARY_NAME)
	chmod +x ../../tools/$(shell go env GOOS)/$(BINARY_NAME)
	@echo "âœ… Installed to ../../tools/$(shell go env GOOS)/$(BINARY_NAME)"

# ì •ë¦¬
clean:
	@echo "ğŸ§¹ Cleaning..."
	rm -rf bin/ coverage.out dist/
	@echo "âœ… Clean complete"

# ë„ì›€ë§
help:
	@echo "Available targets:"
	@echo "  make build            - Build for current platform"
	@echo "  make build-all        - Build for all platforms"
	@echo "  make test             - Run unit tests"
	@echo "  make test-coverage    - Generate test coverage report (HTML)"
	@echo "  make test-integration - Run integration tests"
	@echo "  make bench            - Run benchmarks"
	@echo "  make lint             - Run linter"
	@echo "  make fmt              - Format code"
	@echo "  make deps             - Update dependencies"
	@echo "  make install          - Install binary to tools directory"
	@echo "  make clean            - Clean build artifacts"

